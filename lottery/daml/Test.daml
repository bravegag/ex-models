-- Copyright (c) 2019 Digital Asset (Switzerland) GmbH and/or its affiliates. All rights reserved.
-- SPDX-License-Identifier: Apache-2.0

daml 1.2
module Test where

import DA.Date
import DA.Time
import Lottery
import Iou

data Fixture = Fixture with
  o : Party
  a : Party
  b : Party
  c : Party
  iouIdA : ContractId Iou
  iouIdB : ContractId Iou
  iouIdC : ContractId Iou
  drawId : ContractId Draw

setupFixture : Decimal -> Decimal -> Decimal -> Decimal -> Scenario Fixture
setupFixture amountA amountB amountC threshold =
  do
    i <- getParty "Issuer"
    o <- getParty "Organizer"
    a <- getParty "A"
    b <- getParty "B"
    c <- getParty "C"
    iouIdA <- submit i do create Iou with issuer = i; owner = a; locker = a; amount = amountA; currency = "USD"
    iouIdB <- submit i do create Iou with issuer = i; owner = b; locker = b; amount = amountB; currency = "USD"
    iouIdC <- submit i do create Iou with issuer = i; owner = c; locker = c; amount = amountC; currency = "USD"
    drawId <- submit o do
      create Draw with
        organizer = o
        name = "MyProject"
        description = "A test project"
        players = []
        ious = []
        cashPrize = 0.0
        deadline = time (date 1970 Jan 2) 0 0 0
    inviteId <- submit o do exercise drawId Invite with player = a
    drawId <- submit a do exercise inviteId Accept
    inviteId <- submit o do exercise drawId Invite with player = b
    drawId <- submit b do exercise inviteId Accept
    inviteId <- submit o do exercise drawId Invite with player = c
    drawId <- submit c do exercise inviteId Accept
    drawId <- submit a do exercise drawId BuyTicket with player = a; iouId = iouIdA
    drawId <- submit b do exercise drawId BuyTicket with player = b; iouId = iouIdB
    drawId <- submit c do exercise drawId BuyTicket with player = c; iouId = iouIdC
    pure Fixture with ..

validRun = scenario do
  Fixture{..} <- setupFixture 50.0 25.0 25.0 100.0
  passToDate $ date 1970 Jan 2
  submit o do exercise drawId Run
  
invalidRun = scenario do
  Fixture{..} <- setupFixture 49.0 25.0 25.0 100.0
  passToDate $ date 1970 Jan 2
  submitMustFail o do exercise drawId Run